{% extends "base.html" %}
{% block title %}Reset Password â€“ Physiologic PRISM{% endblock %}

{% block head %}
<style>
  /* Hide navbar on reset password page */
  body > .navbar { display: none !important; }
  .container { max-width: 400px; margin: 80px auto; }
  .password-requirements {
    font-size: 0.9em;
    color: #666;
    margin-top: 8px;
    padding: 12px;
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  .password-requirements ul {
    margin: 8px 0 0 20px;
    padding: 0;
  }
  .password-requirements li {
    margin: 4px 0;
  }
</style>
{% endblock %}

{% block content %}
  <div class="container">
    <h2>Reset Password</h2>
    <p style="color: #666; margin-bottom: 24px;">
      Enter your new password below. Make sure it's secure and at least 8 characters long.
    </p>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div style="padding: 12px; margin-bottom: 16px; border-radius: 4px;
                      background-color: {{ 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' if category == 'success' else '#f8d7da' }};
                      color: {{ '#fff' if category == 'success' else '#721c24' }};">
            {{ message }}
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <form method="POST" action="{{ url_for('reset_password_page', token=token) }}" onsubmit="return validateForm()">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="field-block">
        <input class="input-field" type="password" id="new_password" name="new_password"
               placeholder="New Password" required minlength="8">
      </div>

      <div class="field-block">
        <input class="input-field" type="password" id="confirm_password" name="confirm_password"
               placeholder="Confirm New Password" required minlength="8">
      </div>

      <div class="password-requirements">
        <strong>Password Requirements:</strong>
        <ul>
          <li>At least 8 characters long</li>
          <li>Use a combination of letters, numbers, and symbols</li>
          <li>Avoid using easily guessable information</li>
        </ul>
      </div>

      <div style="margin-top: 24px; display: flex; gap: 12px;">
        <button type="submit" class="button">Reset Password</button>
        <a href="{{ url_for('login') }}" class="button" style="background: #ccc; color: #000;">Cancel</a>
      </div>
    </form>
  </div>

  <script nonce="{{ csp_nonce() }}">
    function validateForm() {
      const newPassword = document.getElementById('new_password').value;
      const confirmPassword = document.getElementById('confirm_password').value;

      if (newPassword.length < 8) {
        alert('Password must be at least 8 characters long');
        return false;
      }

      if (newPassword !== confirmPassword) {
        alert('Passwords do not match. Please try again.');
        return false;
      }

      return true;
    }

    // Show password strength indicator
    document.getElementById('new_password').addEventListener('input', function(e) {
      const password = e.target.value;
      const strength = calculatePasswordStrength(password);
      // You can add visual feedback here if desired
    });

    function calculatePasswordStrength(password) {
      let strength = 0;
      if (password.length >= 8) strength++;
      if (password.length >= 12) strength++;
      if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
      if (/\d/.test(password)) strength++;
      if (/[^a-zA-Z\d]/.test(password)) strength++;
      return strength;
    }
  </script>
{% endblock %}
