<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Physio PRISM{% endblock %}</title>

    <!-- PWA Manifest -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

    <!-- Standard Favicon -->
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='logo.png') }}">

    <!-- PWA Theme Colors -->
    <meta name="theme-color" content="#3b82f6">

    <!-- iOS PWA Support -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="PhysioPRISM">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='logo.png') }}">
    <link rel="apple-touch-icon" sizes="152x152" href="{{ url_for('static', filename='icons/icon-152x152.png') }}">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/icon-180x180.png') }}">

    <!-- Windows/Microsoft PWA Support -->
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-TileImage" content="{{ url_for('static', filename='icons/icon-144x144.png') }}">
    <meta name="msapplication-config" content="{{ url_for('static', filename='browserconfig.xml') }}">

    <!-- SEO and Description -->
    <meta name="description" content="AI-Powered Physiotherapy Practice Management System - Clinical reasoning, patient management, and comprehensive assessment tools">
    <meta name="keywords" content="physiotherapy, practice management, clinical reasoning, patient management, AI-powered, healthcare">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=4">
    <link rel="stylesheet" href="{{ url_for('static', filename='assessmentProgress.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='print.css') }}" media="print">
    <link rel="stylesheet" href="{{ url_for('static', filename='keyboardShortcuts.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='textExpansion.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='autocomplete.css') }}">

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-6MTYYB60PT" nonce="{{ csp_nonce() }}"></script>
    <script nonce="{{ csp_nonce() }}">
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-6MTYYB60PT');
    </script>

    <!-- Chart.js for Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    {% block head %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <div class="navbar-logo">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="PhysioLogic PRISM">
        </div>
        <button class="navbar-toggle" id="navbar-toggle" aria-label="Toggle navigation">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <ul class="navbar-menu" id="navbar-menu">
            <li><a href="{{ url_for('dashboard') }}" title="Dashboard (Press D)">Dashboard</a></li>
            <li><a href="{{ url_for('view_patients') }}" title="View Patients (Press P)">Patients</a></li>
            <li><a href="{{ url_for('add_patient') }}" title="Add Patient (Press N)">Add Patient</a></li>
            <li><a href="https://schedule.physiologicprism.com" target="_blank" title="Schedule Appointments">üìÖ Schedule</a></li>
            <li><a href="{{ url_for('subscription_dashboard') }}" title="Subscription (Press S)">Subscription</a></li>
            <li><a href="{{ url_for('pricing') }}">Pricing</a></li>
            <li><a href="{{ url_for('blog_list') }}" title="Blog (Press B)">Blog</a></li>
            <li class="notification-nav-item">
                <a href="{{ url_for('notifications_page') }}" class="notification-bell-link">
                    üîî Notifications
                    <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
                </a>
            </li>
            <li class="keyboard-shortcuts-nav-item">
                <button id="keyboard-shortcuts-btn" class="keyboard-shortcuts-button" aria-label="Keyboard shortcuts" title="Show keyboard shortcuts (Press ?)">
                    ‚å®Ô∏è
                </button>
            </li>
            <li><a href="{{ url_for('logout') }}">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash {{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <!-- AI Suggestion Modal -->
    <div id="ai-suggestion-modal" class="ai-modal" style="display: none;">
        <div class="ai-modal-overlay"></div>
        <div class="ai-modal-content">
            <div class="ai-modal-header">
                <h3 id="ai-modal-title">AI Suggestions</h3>
                <button class="ai-modal-close" id="ai-modal-close">&times;</button>
            </div>
            <div class="ai-modal-body" id="ai-modal-body">
                <div class="ai-loading">
                    <div class="ai-spinner"></div>
                    <p>Generating suggestions...</p>
                </div>
            </div>
            <div class="ai-modal-footer">
                <button class="ai-btn-secondary" id="ai-modal-copy">Copy All</button>
                <button class="ai-btn-primary" id="ai-modal-dismiss">Done</button>
            </div>
        </div>
    </div>

    {% block scripts %}{% endblock %}

    <script nonce="{{ csp_nonce() }}">
        window.patientId = "{{ patient_id }}";
    </script>

    <!-- Firebase Initialization - MUST load before main.js -->
    <script type="module" nonce="{{ csp_nonce() }}">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        const firebaseConfig = {
            apiKey: "AIzaSyAI2QaNaJuA6cV_KSJlgsyus11-GKzxee8",
            authDomain: "physiologicprism-474610.firebaseapp.com",
            projectId: "physiologicprism-474610",
            storageBucket: "physiologicprism-474610.firebasestorage.app",
            messagingSenderId: "292385113403",
            appId: "1:292385113403:web:02abf02787ba4e02cba31e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        window.__FIREBASE_READY__ = true;
    </script>

    <!-- Main.js loaded as ES module -->
    <script type="module" src="{{ url_for('static', filename='main.js') }}?v=2" nonce="{{ csp_nonce() }}"></script>

    <!-- Assessment Progress Tracker -->
    <script defer src="{{ url_for('static', filename='assessmentProgress.js') }}?v=4" nonce="{{ csp_nonce() }}"></script>

    <!-- Draft Auto-Save System -->
    <script defer src="{{ url_for('static', filename='draftAutoSave.js') }}?v=4" nonce="{{ csp_nonce() }}"></script>

    <!-- Form Change Tracker (must load before version-check) -->
    <script defer src="{{ url_for('static', filename='form-change-tracker.js') }}?v=6" nonce="{{ csp_nonce() }}"></script>

    <!-- Version Check and Auto-Reload System -->
    <script defer src="{{ url_for('static', filename='version-check.js') }}?v=5" nonce="{{ csp_nonce() }}"></script>

    <!-- Keyboard Shortcuts System -->
    <script defer src="{{ url_for('static', filename='keyboardShortcuts.js') }}" nonce="{{ csp_nonce() }}"></script>

    <!-- Voice Recorder (Voice-to-Text) -->
    <script defer src="{{ url_for('static', filename='voiceRecorder.js') }}" nonce="{{ csp_nonce() }}"></script>

    <!-- Text Expansion (Medical Abbreviations) -->
    <script defer src="{{ url_for('static', filename='textExpansion.js') }}" nonce="{{ csp_nonce() }}"></script>

    <!-- Smart Autocomplete (Learn from History) -->
    <script defer src="{{ url_for('static', filename='autocomplete.js') }}" nonce="{{ csp_nonce() }}"></script>

    <!-- Service Worker Registration -->
    <script nonce="{{ csp_nonce() }}">
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          // Register with updateViaCache: 'none' to prevent caching of SW file
          navigator.serviceWorker.register('/service-worker.js', { updateViaCache: 'none' })
            .then((registration) => {
              console.log('[SW] Registered successfully:', registration.scope);

              // Listen for updates and reload page automatically
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                  if (newWorker.state === 'activated' && navigator.serviceWorker.controller) {
                    console.log('[SW] New version activated - reloading page');
                    window.location.reload();
                  }
                });
              });

              // Check for updates immediately
              registration.update();

              // Check for updates every 5 minutes (aggressive for bug fixes)
              setInterval(() => {
                registration.update();
              }, 5 * 60 * 1000);
            })
            .catch((error) => {
              console.warn('[SW] Registration failed:', error);
            });
        });
      }
    </script>

    <!-- AI Disclaimer -->
    <div class="ai-disclaimer">
        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 6px; flex-shrink: 0;">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
        </svg>
        <span>AI suggestions are for clinical reasoning assistance only. Always verify with professional judgment.</span>
    </div>

    <!-- Notification Badge Update Script -->
    <script nonce="{{ csp_nonce() }}">
        async function updateNotificationBadge() {
            try {
                const response = await fetch('/api/notifications/unread-count');
                if (response.ok) {
                    const data = await response.json();
                    const badge = document.getElementById('notification-badge');

                    if (badge && data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'inline-block';
                    } else if (badge) {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating notification badge:', error);
            }
        }

        // Update badge on page load
        document.addEventListener('DOMContentLoaded', updateNotificationBadge);

        // Update badge every 2 minutes
        setInterval(updateNotificationBadge, 120000);
    </script>

    <!-- Mobile Navbar Toggle Script -->
    <script nonce="{{ csp_nonce() }}">
        document.addEventListener('DOMContentLoaded', function() {
            const navbarToggle = document.getElementById('navbar-toggle');
            const navbarMenu = document.getElementById('navbar-menu');

            if (navbarToggle && navbarMenu) {
                navbarToggle.addEventListener('click', function() {
                    navbarToggle.classList.toggle('active');
                    navbarMenu.classList.toggle('active');
                });

                // Close menu when clicking on a link
                const navLinks = navbarMenu.querySelectorAll('a');
                navLinks.forEach(link => {
                    link.addEventListener('click', function() {
                        navbarToggle.classList.remove('active');
                        navbarMenu.classList.remove('active');
                    });
                });

                // Close menu when clicking outside
                document.addEventListener('click', function(event) {
                    const isClickInsideNav = navbarToggle.contains(event.target) || navbarMenu.contains(event.target);
                    if (!isClickInsideNav && navbarMenu.classList.contains('active')) {
                        navbarToggle.classList.remove('active');
                        navbarMenu.classList.remove('active');
                    }
                });
            }
        });
    </script>

    <style>
        .notification-nav-item {
            position: relative;
        }

        .notification-bell-link {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .notification-badge {
            background: #e74c3c;
            color: white;
            font-size: 11px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 10px;
            position: absolute;
            top: -8px;
            right: -12px;
            min-width: 18px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
    </style>

    <!-- Copyright Notice - Authenticated Pages -->
    <div style="
        position: fixed;
        bottom: 0;
        right: 0;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.95);
        border-top: 1px solid #e0e0e0;
        border-left: 1px solid #e0e0e0;
        border-top-left-radius: 8px;
        font-size: 0.75em;
        color: #666;
        z-index: 999;
        box-shadow: 0 -2px 8px rgba(0,0,0,0.05);
    ">
        &copy; 2025 PhysiologicPRISM | PRISM Framework
    </div>

    <!-- Cookie Consent Banner -->
    {% include 'cookie_consent.html' %}
</body>
</html>
