{% extends "base.html" %}
{% block title %}Patient Functioning Assessment â€“ Physiologic PRISM{% endblock %}

{% block head %}
<style>
  .field-block { position: relative; margin-top: 12px; }
  .field-block label { display: block; margin-bottom: 4px; font-weight: 500; }
  .control-group { display: flex; align-items: flex-start; gap: 8px; }
  .control-group .input-field { flex: 1; }
  .input-field { flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  .ai-btn { background: none; border: none; font-size: 1.2em; cursor: pointer; flex-shrink: 0; margin-top: 0.5rem; }
  .ai-popup { position: absolute; top: 2.5rem; right: 0; max-width: 300px; background: #fff; border: 1px solid #ccc; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); display: none; z-index: 100; }
</style>
{% endblock %}

{% block content %}
  <div class="container">
    <h2>Patient Functioning Assessment for {{ patient_id }}</h2>
    <form method="POST" id="subjective-form" action="{{ url_for('subjective', patient_id=patient_id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="age_sex"        value="{{ patient.age_sex }}">
      <input type="hidden" name="present_history" value="{{ patient.present_history }}">
      <input type="hidden" name="past_history"    value="{{ patient.past_history }}">


      {% set fields = [
        ['body_structure', 'Impairment of body structure'],
        ['body_function', 'Impairment of body function'],
        ['activity_performance', 'Activity limitation / Participation â€“ Performance'],
        ['activity_capacity', 'Activity limitation / Participation â€“ Capacity'],
        ['contextual_environmental', 'Contextual Factors â€“ Environmental'],
        ['contextual_personal', 'Contextual Factors â€“ Personal']
      ] %}

      {% for name,label in fields %}
      <div class="field-block">
        <label for="{{ name }}">{{ label }}:</label>
        <div class="control-group">
          <textarea id="{{ name }}" name="{{ name }}" class="input-field" rows="2" data-voice-enabled required>{{ request.form[name] or '' }}</textarea>
          <button type="button" class="ai-btn" data-field="{{ name }}" title="Suggest {{ label|lower }}">ðŸ§ </button>
        </div>
        <div id="{{ name }}_popup" class="ai-popup"></div>
      </div>
      {% endfor %}

      <div style="display:flex; align-items:center; gap:12px; margin-top:16px; flex-wrap: wrap;">
        <button type="submit" class="button">Save &amp; Continue</button>
        <button type="button" id="gen_subjective_dx" class="button" title="Generate subjective diagnosis">ðŸ©º Generate Diagnosis</button>
        <a href="{{ url_for('patho_mechanism', patient_id=patient_id) }}" class="button-secondary">&larr; Back to Patho Mechanism</a>
      </div>
    </form>
  </div>

  <script nonce="{{ csp_nonce() }}">
    // Make patient_id available globally for AI suggestions
    window.currentPatientId = '{{ patient_id }}';

    // Initialize Draft Auto-Save
    let draftAutoSave;

    document.addEventListener('DOMContentLoaded', function() {
      draftAutoSave = new DraftAutoSave('subjective', '{{ patient_id }}', {
        saveDelay: 2000, // Save 2 seconds after user stops typing
        onRestore: function(data) {
          console.log('Draft restored with data:', data);
        },
        onSave: function(data) {
          console.log('Draft saved:', data);
        }
      });

      console.log('Draft auto-save initialized for subjective examination');
    });
  </script>
{% endblock %}


