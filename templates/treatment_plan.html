{% extends "base.html" %}
{% block title %}Treatment Plan â€“ Physiologic PRISM{% endblock %}

{% block head %}
<style>
  .field-block { position: relative; margin-top: 20px; }
  .field-block label { display: block; margin-bottom: 4px; font-weight: 500; }
  .control-group { display: flex; align-items: flex-start; gap: 8px; }
  .control-group .input-field { flex: 1; }
  .input-field { width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  .ai-btn { background: none; border: none; font-size: 1.2em; cursor: pointer; padding: 0; flex-shrink: 0; margin-top: 0.5rem; }
  .ai-popup {
    position: absolute; top: 2.5rem; right: 0; max-width: 300px;
    background: #fff; padding: 0.75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    display: none; z-index: 100;
  }
  @media print {
    button { display: none !important; }
    nav.navbar { display: none !important; }
  }
</style>
{% endblock %}

{% block content %}
  <div class="container">
    <h2>Treatment Plan for {{ patient_id }}</h2>
    <form method="POST" action="{{ url_for('treatment_plan', patient_id=patient_id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

      {% set fields = [
        ['treatment_plan', 'Treatment Plan', 'Enter treatment planâ€¦'],
        ['goal_targeted', 'Goal Targeted', "Enter the goal you're targetingâ€¦"],
        ['reasoning', 'Reasoning', 'Enter your clinical reasoningâ€¦'],
        ['reference', 'Reference (Article/Book/Literature)', 'Enter referencesâ€¦']
      ] %}

      {% for name,label,placeholder in fields %}
        <div class="field-block">
          <label for="{{ name }}">{{ label }}:</label>
          <div class="control-group">
            <textarea id="{{ name }}" name="{{ name }}" class="input-field" rows="3" placeholder="{{ placeholder }}">{{ request.form[name] or '' }}</textarea>
            <button type="button" class="ai-btn" data-field="{{ name }}" title="Ask AI for suggestions">ðŸ§ </button>
          </div>
          <div id="{{ name }}_popup" class="ai-popup"></div>
        </div>
      {% endfor %}

      <div style="margin-top:24px; display:flex; gap:12px; align-items:center; flex-wrap: wrap;">
        <button type="submit" class="button">Save &amp; Return to Dashboard</button>
        <button type="button" class="button" id="gen_summary">âš¡ Generate Summary</button>
        <a href="{{ url_for('smart_goals', patient_id=patient_id) }}" class="button" style="background:#ccc; color:#000;">
          &larr; Back to SMART Goals
        </a>
      </div>
    </form>
  </div>

<script nonce="{{ csp_nonce() }}">
  // Make patient_id available globally for AI suggestions
  window.currentPatientId = '{{ patient_id }}';

  let draftAutoSave;
  document.addEventListener('DOMContentLoaded', function() {
    draftAutoSave = new DraftAutoSave('treatment_plan', '{{ patient_id }}', {
      saveDelay: 2000
    });
    console.log('Draft auto-save initialized for treatment plan');
  });
</script>
{% endblock %}

