{% extends "base.html" %}
{% block title %}Patient List – Physiologic PRISM{% endblock %}

{% block head %}
<style>
  .filter-form { margin-bottom: 16px; }
  .patient-card {
    border: 1px solid #ddd;
    margin: 10px 0;
    padding: 15px;
    background: #f9f9f9;
  }
  .data-table {
    width: 100%;
    border-collapse: collapse;
  }
  .data-table th, .data-table td {
    border: 1px solid #ccc;
    padding: 8px;
    text-align: left;
  }
  .actions {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <h2>Patient List</h2>

  <form method="GET" class="filter-form">
    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
      <label>Filter by Name:
        <input type="text" name="name" placeholder="Enter Name" value="{{ request.args.get('name', '') }}">
      </label>
      <label>Filter by Patient ID:
        <input type="text" name="patient_id" placeholder="Enter ID" value="{{ request.args.get('patient_id', '') }}">
      </label>
      <button type="submit" class="button">Apply Filters</button>
    </div>
  </form>

  <p>Found {{ patients|length }} patients</p>

  <table class="data-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Patient Name</th>
        <th>Age/Sex</th>
        <th>Contact</th>
        <th>Date Added</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for patient in patients %}
      <tr>
        <td>{{ patient.get('patient_id') or patient.get('doc_id') or 'N/A' }}</td>
        <td>
          {{ patient.get('name')
            or patient.get('subjectiveExamination', {}).get('contextualFactorsPersonal')
            or patient.get('contextualFactorsPersonal')
            or 'N/A' }}
        </td>
        <td>{{ patient.get('age_sex') or patient.get('ageSex') or 'N/A' }}</td>
        <td>{{ patient.get('contact') or patient.get('contactDetails') or 'N/A' }}</td>
        <td>
          {# Safer date rendering without hasattr — just show whatever we have as a string #}
          {% set created_at = patient.get('created_at') %}
          {{ created_at|string if created_at else 'N/A' }}
        </td>
        <td class="actions">
          <a href="{{ url_for('edit_patient', patient_id=patient.get('patient_id') or patient.get('doc_id')) }}" class="button">Edit</a>
          <a href="{{ url_for('follow_ups', patient_id=patient.get('patient_id') or patient.get('doc_id')) }}" class="button green">Add Follow-Up</a>
          <a href="{{ url_for('view_follow_ups', patient_id=patient.get('patient_id') or patient.get('doc_id')) }}" class="button green">View Follow-Ups</a>
          <a href="{{ url_for('patient_report', patient_id=patient.get('patient_id') or patient.get('doc_id')) }}" class="button">Report</a>
          <a href="{{ url_for('download_report', patient_id=patient.get('patient_id') or patient.get('doc_id')) }}" class="button">PDF</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div style="margin-top: 24px;">
    <a href="{{ url_for('dashboard') }}" class="button">&larr; Back to Dashboard</a>
  </div>
</div>
{% endblock %}
