{% extends "base.html" %}
{% block title %}Follow-Up Sessions â€“ Physiologic PRISM{% endblock %}

{% block head %}
<style>
  .field-block { position: relative; margin-top: 12px; }
  .control-group { display: flex; align-items: flex-start; gap: 8px; }
  .control-group .input-field { flex: 1; }
  .ai-btn { background: none; border: none; font-size: 1.2em; cursor: pointer; flex-shrink: 0; margin-top: 0.5rem; }
  .ai-popup { position: absolute; top: 100%; right: 0; max-width: 300px; background: #fff; border: 1px solid #ccc; padding: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); display: none; z-index: 100; }
</style>
{% endblock %}

{% block content %}
  <div class="container">
    <h2>Follow-Up History for {{ patient.name }} (ID: {{ patient.patient_id }})</h2>

    {% if followups %}
      <table class="data-table">
        <thead>
          <tr>
            <th>Session #</th>
            <th>Date</th>
            <th>Grade</th>
            <th>Perception</th>
            <th>Feedback</th>
            <th>Treatment Plan</th>
          </tr>
        </thead>
        <tbody>
          {% for f in followups %}
            <tr>
              <td>{{ f.session_number }}</td>
              <td>{{ f.session_date | datetimeformat }}</td>
              <td>{{ f.grade }}</td>
              <td>{{ f.perception or f.belief_treatment }}</td>
              <td>{{ f.feedback or f.belief_feedback }}</td>
              <td>{{ f.treatment_plan }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p>No follow-up records found for this patient.</p>
    {% endif %}

    <h3>Add New Follow-Up</h3>
    <form method="POST" action="{{ url_for('follow_ups', patient_id=patient.patient_id) }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <label>Session Number:</label>
      <input type="number" name="session_number" class="input-field" value="{{ followups|length + 1 }}" readonly>

      <label>Date:</label>
      <input type="date" name="session_date" class="input-field" required>

      <label>Grade of Achievement:</label>
      <select name="grade" class="input-field" required>
        <option value="">Select</option>
        <option value="Not Achieved">Not Achieved</option>
        <option value="Partially Achieved">Partially Achieved</option>
        <option value="Fully Achieved">Fully Achieved</option>
      </select>

      <label>Perception of Treatment:</label>
      <select name="belief_treatment" class="input-field">
        <option value="">Select</option>
        <option value="Very Effective">Very Effective</option>
        <option value="Somewhat Effective">Somewhat Effective</option>
        <option value="Not Effective">Not Effective</option>
      </select>

      <label>Feedback:</label>
      <textarea name="belief_feedback" class="input-field" rows="3" placeholder="Enter feedback..." data-voice-enabled></textarea>

      <label>Plan for Next Treatment:</label>
      <div class="field-block">
        <div class="control-group">
          <textarea
            id="plan_next"
            name="plan_next"
            class="input-field"
            rows="3"
            placeholder="Describe treatment strategyâ€¦"
            data-voice-enabled
          >{{ request.form.plan_next or '' }}</textarea>
          <button
            type="button"
            class="ai-btn"
            title="Ask AI for nextâ€‘session plan"
          >ðŸ§ </button>
        </div>
        <div id="plan_next_popup" class="ai-popup"></div>
      </div>

      <div id="ai_summary" class="ai-popup" style="white-space: pre-wrap; background: #f0f0f0; padding: 8px; border-radius: 4px; margin-top: 8px;"></div>

      <div style="margin-top:16px; display:flex; gap:12px;">
        <button type="submit" class="button">Save Follow-Up</button>
        <a href="{{ url_for('view_patients') }}" class="button">Cancel</a>
      </div>
    </form>

    <!-- Schedule Next Follow-up -->
    <div style="margin-top: 40px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
      <h3 style="margin-top: 0; color: #2c3e50;">ðŸ“… Schedule Next Follow-up</h3>
      <p style="color: #7f8c8d; margin-bottom: 16px;">Set a reminder for the patient's next appointment. You'll receive notifications as the date approaches.</p>

      <div style="display: flex; gap: 12px; align-items: flex-end;">
        <div style="flex: 1;">
          <label>Next Follow-up Date:</label>
          <input type="date" id="next_followup_date" class="input-field" value="{{ patient.next_followup_date or '' }}">
        </div>
        <button onclick="setNextFollowup()" class="button" style="background: #3498db;">Set Reminder</button>
      </div>

      {% if patient.next_followup_date %}
      <div style="margin-top: 12px; padding: 12px; background: white; border-radius: 4px;">
        <strong>Current Reminder:</strong> {{ patient.next_followup_date }}
        {% if patient.followup_notified %}
          <span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">âœ“ Patient Notified</span>
        {% else %}
          <span style="background: #95a5a6; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 8px;">Not Notified</span>
          <button onclick="markNotified()" class="button" style="background: #27ae60; font-size: 12px; padding: 6px 12px; margin-left: 8px;">Mark as Notified</button>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <script nonce="{{ csp_nonce() }}">
      async function setNextFollowup() {
        const date = document.getElementById('next_followup_date').value;

        if (!date) {
          alert('Please select a date');
          return;
        }

        try {
          const response = await fetch('/api/patient/{{ patient.patient_id }}/set_next_followup', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              next_followup_date: date
            })
          });

          const data = await response.json();

          if (data.ok) {
            alert('Next follow-up reminder set successfully!');
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error setting follow-up:', error);
          alert('Error setting follow-up reminder');
        }
      }

      async function markNotified() {
        if (!confirm('Mark this patient as notified about their upcoming follow-up?')) {
          return;
        }

        try {
          const response = await fetch('/api/patient/{{ patient.patient_id }}/mark_followup_notified', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          const data = await response.json();

          if (data.ok) {
            alert('Patient marked as notified!');
            location.reload();
          } else {
            alert('Error: ' + (data.error || 'Unknown error'));
          }
        } catch (error) {
          console.error('Error marking as notified:', error);
          alert('Error marking patient as notified');
        }
      }
    </script>
  </div>
{% endblock %}

